jobs:
<<- define "helm-base" >>

  helm-lint-test:
    name: Helm Lint & Test
    runs-on: ubuntu-latest
    needs: run-workflow
    steps:
      - uses: actions/checkout@v4
      # https://github.com/marketplace/actions/helm-tool-installer
      - uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-tags packageName=helm/helm versioning=semver
          version: v3.16.2
      # https://github.com/marketplace/actions/setup-python
      - uses: actions/setup-python@v5
        with:
          check-latest: true
          # renovate: datasource=github-tags packageName=actions/python-versions versioning=npm
          python-version: 3.x
      # https://github.com/marketplace/actions/helm-chart-testing
      - uses: helm/chart-testing-action@v2
      - id: changed
        run: |-
          changed=$(ct list-changed --chart-dirs "$HELM_CHART_DIR" --target-branch "$TARGET_BRANCH")
          [ -z "$changed" ] || echo "changed=true" >> "$GITHUB_OUTPUT"
        env:
          HELM_CHART_DIR: chart/
          TARGET_BRANCH: ${{ github.event.pull_request.base_ref || github.event.repository.default_branch }}
      - if: ${{ steps.changed.outputs.changed == 'true' }}
        run: ct lint --chart-dirs "$HELM_CHART_DIR" --target-branch "$TARGET_BRANCH"
        env:
          HELM_CHART_DIR: chart/
          TARGET_BRANCH: ${{ github.event.pull_request.base_ref || github.event.repository.default_branch }}
<<- end >>

<<- define "helm-deploy" >>

<<- $golang := hasKey .Languages "go" >>
<<- $node := hasKey .Languages "node" >>

<<- $registry := .CI.Helm.Registry | default "oci://ghcr.io" >>
<<- $path := .CI.Helm.Path | default .ProjectPath >>
<<- $ghcr := and (eq $registry "oci://ghcr.io") (eq $path .ProjectPath) >>

<<- if .HasHelmPublish >>

  helm-push:
    name: Helm Push
    runs-on: ubuntu-latest
<<- if eq .CI.Helm.Publish "auto" >>
    if: ${{ ((github.event_name == 'push' && github.ref_protected) || github.event_name == 'workflow_dispatch') }}
<<- else >>
    if: ${{ github.event_name == 'workflow_dispatch' }}
<<- end >>
    needs:
      - helm-lint-test
<<- if .CI.Docker >>
      - docker-build
<<- else >>
<<- if $golang >>
      - go-test
<<- end >>
<<- if $node >>
      - node-test
<<- end >>
<<- end >>
      - version
    permissions:
      packages: << $ghcr | ternary "write" "none" >>
    steps:
      - uses: actions/checkout@v4
      # https://github.com/marketplace/actions/helm-tool-installer
      - uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-tags packageName=helm/helm versioning=semver
          version: v3.16.2
      - run: helm package --version "$VERSION" --app-version "$VERSION" --dependency-update "$HELM_CHART_DIR"
        env:
          HELM_CHART_DIR: chart/
          VERSION: ${{ needs.version.outputs.version }}
      - run: |-
<<- if not (hasPrefix "oci://" $registry) >>
          helm plugin install https://github.com/chartmuseum/helm-push
<<- end >>
          helm registry login "$HELM_REGISTRY" -u "$HELM_REPO_USERNAME" -p "$HELM_REPO_ACCESS_TOKEN"
          helm << hasPrefix "oci://" $registry | ternary "push" "cm-push" >> "$HELM_CHART_PATH" "$HELM_PUBLISH_URL"
        env:
          HELM_CHART_PATH: ${{ github.event.repository.name }}-${{ needs.helm-check.outputs.version }}.tgz
          HELM_PUBLISH_URL: << $registry >>/<< trimSuffix (print "/" .ProjectName) $path >>
          HELM_REGISTRY: << trimPrefix "oci://" $registry >>
<<- if $ghcr >>
          HELM_REPO_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HELM_REPO_USERNAME: ${{ github.repository_owner }}
<<- else >>
          HELM_REPO_ACCESS_TOKEN: ${{ secrets.HELM_REPO_ACCESS_TOKEN || secrets.HELM_REPO_PASSWORD }}
          HELM_REPO_AUTH_HEADER: ${{ secrets.HELM_REPO_AUTH_HEADER }}
          HELM_REPO_USE_HTTP: ${{ secrets.HELM_REPO_USE_HTTP }}
          HELM_REPO_USERNAME: ${{ secrets.HELM_REPO_USERNAME || github.repository_owner }}
<<- end >>
<<- end >>

<<- if .IsDeployment "kubernetes" >>

  helm-deploy:
    name: Helm Deploy
    runs-on: ubuntu-latest
<<- if .CI.Deployment.Auto >>
    if: ${{ (github.event_name == 'push' && github.ref_protected) || github.event_name == 'workflow_dispatch' }}
<<- else >>
    if: ${{ github.event_name == 'workflow_dispatch' }}
<<- end >>
    needs:
<<- if not .HasHelmPublish >>
      - helm-lint-test
<<- end >>
<<- if .HasHelmPublish >>
      - helm-push
<<- else if .CI.Docker >>
      - docker-build
<<- else >>
<<- if $golang >>
      - go-test
<<- end >>
<<- if $node >>
      - node-test
<<- end >>
<<- end >>
      - version
    environment: ${{ matrix.environment }}
    strategy:
      fail-fast: false
      # see https://github.com/orgs/community/discussions/26253#discussioncomment-3250989
      # for more information about how to exclude environments depending on branches
      matrix:
        environment:
          - review
          - integration
          - staging
          - production
        production:
          - ${{ github.ref_name == github.event.repository.default_branch }}
        protected:
          - ${{ github.ref_name == github.event.repository.default_branch || github.ref_protected }}
        exclude:
          - environment: review # disable on protected branches
            protected: true
          - environment: integration # disable on non-protected branches
            protected: false
          - environment: staging # disable on non-production branches
            production: false
          - environment: production # disable on non-production branches
            production: false
    steps:
      - uses: actions/checkout@v4
      # https://github.com/marketplace/actions/helm-tool-installer
      - uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-tags packageName=helm/helm versioning=semver
          version: v3.16.2
      - shell: bash
        run: |-
          args=(--install --kube-context "$ENVIRONMENT" --version "$VERSION" -f "$HELM_CHART_DIR/values.yaml" --set "appVersion=$VERSION")
          [ -z "$HELM_ARGS" ] || args+=("$HELM_ARGS")

          name="$GITHUB_REPOSITORY_NAME-$VERSION"
          [ "$ENVIRONMENT" = "review" ] || name="$GITHUB_REPOSITORY_NAME"

          echo "Running helm upgrade with args '${args[@]}'"
          helm upgrade "${args[@]}" "$name" "${HELM_CHART_URL:-$HELM_CHART_DIR}"
        env:
          ENVIRONMENT: ${{ matrix.environment }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          HELM_ARGS: ${{ vars.HELM_ARGS }}
          HELM_CHART_DIR: chart/
<<- if .HasHelmPublish >>
          HELM_CHART_URL: << $registry >>/<< $path >>
<<- end >>
          VERSION: ${{ needs.helm-check.outputs.version }}
<<- end >>
<<- end >>
