jobs:
<<- define "golang" >>

<<- $wrun := or .IsHelmPublishAuto .IsDeploymentAuto .IsReleaseAuto >>

  go-build:
    name: Go Build
    runs-on: ubuntu-latest
<<- if $wrun >>
    needs:
      - run-workflow
      - version
<<- else >>
    needs: version
<<- end >>
    steps:
      - uses: actions/checkout@v4
<<- if $wrun >>
        with:
          ref: ${{ needs.run-workflow.outputs.ref_name }}
<<- end >>
      - uses: actions/setup-go@v5
        with:
          check-latest: true
          go-version-file: go.mod
          token: ${{ secrets.GITHUB_TOKEN }}
      # https://github.com/marketplace/actions/goreleaser-action
      - if: ${{ hashFiles('.goreleaser.yml') != '' }}
        uses: goreleaser/goreleaser-action@v6
        with:
          args: release --clean --config .goreleaser.yml --skip=validate --skip=announce --skip=publish --snapshot
        env:
          VERSION: ${{ needs.version.outputs.version }}
      - uses: actions/upload-artifact@v4
        with:
          name: build
          # order is important to filter unwanted globs after the filter or desired globs
          path: |
            dist/*
            !dist/*.json
            !dist/*.yaml
            !dist/*/
          retention-days: 1
<<- end >>
