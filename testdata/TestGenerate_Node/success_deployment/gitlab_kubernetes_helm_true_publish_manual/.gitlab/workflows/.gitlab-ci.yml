# Code generated by craft; DO NOT EDIT.

---
include:

  # semantic-release template
  - project: to-be-continuous/semantic-release
    ref: "3"
    file: "templates/gitlab-ci-semrel.yml"

  # pre-commit template
  - project: to-be-continuous/pre-commit
    ref: "1"
    file: "templates/gitlab-ci-pre-commit.yml"

  # Helm template
  - project: to-be-continuous/helm
    ref: "8"
    file: "templates/gitlab-ci-helm.yml"

  # Node.js template
  - project: to-be-continuous/node
    ref: "3"
    file: "templates/gitlab-ci-node.yml"

variables:
  SEMREL_AUTO_RELEASE_ENABLED: false
  SEMREL_BRANCHES_REF: /^(master|main|v[0-9]+\.x|v[0-9]+\.[0-9]+\.x|next|alpha|beta|staging|dev|develop|development)$/
  SEMREL_HOOKS_DIR: scripts
  SEMREL_INFO_ON: all
  SEMREL_RELEASE_DISABLED: "true"
  SEMREL_REQUIRED_PLUGINS_FILE: .gitlab/semrel-plugins.txt
  SEMREL_TAG_FORMAT: v$${version}

  PRE_COMMIT_FILE: .pre-commit-config.yaml

  HELM_CHART_DIR: chart/
  HELM_SCRIPTS_DIR: chart/hooks/
  HELM_SEMREL_RELEASE_DISABLED: "true" # version is handled manually
  HELM_TEST_ENABLED: "false"

  HELM_PACKAGE_ARGS: package --version "$SEMREL_INFO_NEXT_VERSION" --app-version "$SEMREL_INFO_NEXT_VERSION" --dependency-update
  HELM_PUBLISH_METHOD: push
  HELM_PUBLISH_ON: all
  HELM_PUBLISH_SNAPSHOT_ENABLED: "false"
  HELM_PUBLISH_STRATEGY: manual
  HELM_PUBLISH_URL: oci://$CI_REGISTRY/$CI_PROJECT_PATH/charts

  HELM_REVIEW_ENABLED: "true"
  HELM_INTEG_ENABLED: "true"
  HELM_STAGING_ENABLED: "true"
  HELM_PROD_ENABLED: "true"

  HELM_DEPLOY_ARGS: upgrade --install --version "$SEMREL_INFO_NEXT_VERSION" -f "$HELM_CHART_DIR/values.yaml" --set "appVersion=$SEMREL_INFO_NEXT_VERSION"
  HELM_PROD_DEPLOY_STRATEGY: manual

  HELM_INTEG_APP_NAME: $HELM_BASE_APP_NAME
  HELM_REVIEW_APP_NAME: $HELM_BASE_APP_NAME-$SEMREL_INFO_NEXT_VERSION
  HELM_STAGING_APP_NAME: $HELM_BASE_APP_NAME

  NODE_AUDIT_DISABLED: "false"
  NODE_BUILD_ARGS: run build --prod
  NODE_IMAGE: registry.hub.docker.com/library/node:lts-alpine
  NODE_LINT_ARGS: "run lint"
  NODE_LINT_ENABLED: "true"
  NODE_OUTDATED_ARGS: --long
  NODE_OUTDATED_DISABLED: "false"
  NODE_PUBLISH_ENABLED: "false"
  NODE_SBOM_DISABLED: "true"
  NODE_SEMGREP_DISABLED: "false" # https://semgrep.dev/docs/
  NODE_TEST_ARGS: test -- --coverage

semantic-release-info:
  variables:
    GIT_DEPTH: "0"
  after_script:
    - source "$SEMREL_CONFIG_DIR/semrel.out.env" && rm "$SEMREL_CONFIG_DIR/semrel.out.env"
    - >
      echo "BRANCH_SHA=$(echo "$CI_COMMIT_REF_NAME" | sha256sum | cut -c -8)" >> "$SEMREL_CONFIG_DIR/semrel.out.env"

      if [ -n "$SEMREL_INFO_NEXT_VERSION" ]; then
        echo "SEMREL_INFO_LAST_VERSION=v${SEMREL_INFO_LAST_VERSION#v}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION=v${SEMREL_INFO_NEXT_VERSION#v}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION_TYPE=${SEMREL_INFO_NEXT_VERSION_TYPE}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
      else
        DESCRIBE=$(git describe --tags || echo "v1.0.0")
        echo "SEMREL_INFO_NEXT_VERSION=v${DESCRIBE#v}" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
        echo "SEMREL_INFO_NEXT_VERSION_TYPE=build" >> "$SEMREL_CONFIG_DIR/semrel.out.env"
      fi
    - cat "$SEMREL_CONFIG_DIR/semrel.out.env"

semantic-release:
  variables:
    GIT_DEPTH: "0"
